name: Flutter CI/CD TEST VERSION

on:
  push:
    branches:
      - test-workflows

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    # - name: Setup Node.js environment
    #   uses: actions/setup-node@v3
    #   with:
    #     node-version: '20.9.0' # specify the Node version
    # hehehehe

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.7' # specify the Flutter version

    - name: Install Flutter dependencies
      run: flutter pub get

    - name: Test Python
      run: python --version

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install docker

    - name: Test docker
      env:
        GITHUB_ACTOR: ${{ github.actor }}
        GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      run: python scripts/docker_ctrl.py start ghcr.io/mittons/sharpwingback:latest 3000 5000

    - name: Unit tests
      run: flutter test

    - name: Integration tests
      env:
        GITHUB_ACTOR: ${{ github.actor }}
        GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      run: flutter test integration_test -d windows

    - name: Build Flutter Web
      run: flutter build web --release --dart-define=FLAVOR=prod --base-href /SharpWingFrontend/

