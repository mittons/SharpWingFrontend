name: Flutter CI/CD TEST VERSION

on:
  push:
    branches:
      - test-workflows

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # - name: Setup Node.js environment
    #   uses: actions/setup-node@v3
    #   with:
    #     node-version: '20.9.0' # specify the Node version
    # hehehehe

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.9' # specify the Flutter version
        cache: true

    - name: Install Flutter dependencies
      run: flutter pub get

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install docker

    # - name: Test docker
    #   env:
    #     GITHUB_ACTOR: ${{ github.actor }}
    #     GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    #   run: python scripts/docker_ctrl.py start ghcr.io/mittons/sharpwingback:latest 3000 5000
    
    - name: Install ChromeDriver
      run: |
        wget -N https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/120.0.6099.71/linux64/chromedriver-linux64.zip -P ~/
        unzip ~/chromedriver-linux64.zip -d ~/
        rm ~/chromedriver-linux64.zip
        sudo mv -f ~/chromedriver-linux64 /usr/local/bin/chromedriver
        sudo chown root:root /usr/local/bin/chromedriver
        sudo chmod 0755 /usr/local/bin/chromedriver
          
    - name: ðŸ“¢ Check Chromedriver Version
      run: chromedriver -v

    - name: Flutter Doctor
      run: flutter doctor -v

    - name: Unit tests
      run: flutter test

    - name: Integration tests
      env:
        GITHUB_ACTOR: ${{ github.actor }}
        GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      run: |
          chromedriver --port=4444 --trace-buffer-size=100000 &
          flutter drive \
              --verbose-system-logs \
              -d web-server \
              --driver=test_driver/integration_test.dart \
              --target=integration_test/screens/task_list_screen_test.dart


    # - name: Integration tests
    #   env:
    #     GITHUB_ACTOR: ${{ github.actor }}
    #     GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    #   run: flutter test integration_test -d windows

    - name: Build Flutter Web
      run: flutter build web --release --dart-define=FLAVOR=prod --base-href /SharpWingFrontend/

